<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aunikah - Smart Employment Assistant</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;flex-direction:column;padding:20px}
    .chat-container{width:100%;max-width:900px;height:calc(100vh - 40px);background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);display:flex;flex-direction:column;overflow:hidden;margin:0 auto}
    .chat-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px}
    .header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:15px}
    .header-info{display:flex;align-items:center;gap:15px}
    .bot-avatar{width:50px;height:50px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;color:#667eea}
    .header-text h1{font-size:22px;margin-bottom:5px}
    .header-text p{font-size:14px;opacity:.9}
    .badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px}
    .badge-detection{background:rgba(255,255,255,.3)}
    .badge-client{background:rgba(66,153,225,.3)}
    .badge-employer{background:rgba(159,122,234,.3)}
    .mode-selector{display:flex;gap:10px}
    .mode-btn{padding:8px 16px;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.3);border-radius:20px;color:#fff;cursor:pointer;font-size:13px;transition:all .3s}
    .mode-btn:hover{background:rgba(255,255,255,.3)}
    .mode-btn.active{background:#fff;color:#667eea;border-color:#fff}
    .demo-notice{background:rgba(255,255,255,.15);padding:12px;border-radius:10px;font-size:13px}
    .demo-notice strong{display:block;margin-bottom:5px}
    .quick-setup{background:#fff;border-radius:10px;padding:15px;margin-top:10px;color:#333;display:none}
    .quick-setup.active{display:block}
    .quick-setup h3{font-size:14px;margin-bottom:10px;color:#667eea}
    .company-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .company-btn{padding:6px 12px;background:#f0f4ff;border:1px solid #667eea;border-radius:6px;cursor:pointer;font-size:12px;color:#667eea;transition:all .2s}
    .company-btn:hover{background:#667eea;color:#fff}
    .chat-messages{flex:1;overflow-y:auto;padding:20px;background:#f8f9fa}
    .message{display:flex;gap:10px;margin-bottom:15px;animation:slideIn .3s ease}
    @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .message.user{flex-direction:row-reverse}
    .message-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;flex-shrink:0;font-size:14px}
    .message.bot .message-avatar{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .message.user .message-avatar{background:#6c757d}
    .message-content{max-width:70%;padding:12px 16px;border-radius:12px;line-height:1.6;white-space:pre-line}
    .message.bot .message-content{background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1);color:#333}
    .message.user .message-content{background:#667eea;color:#fff}
    .typing-indicator{display:none;padding:15px;background:#fff;border-radius:12px;width:fit-content}
    .typing-indicator.active{display:flex;gap:4px}
    .typing-dot{width:8px;height:8px;border-radius:50%;background:#667eea;animation:typing 1.4s infinite}
    .typing-dot:nth-child(2){animation-delay:.2s}
    .typing-dot:nth-child(3){animation-delay:.4s}
    @keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-10px)}}
    .chat-input-container{padding:20px;background:#fff;border-top:1px solid #e9ecef}
    .chat-input-wrapper{display:flex;gap:10px}
    .chat-input{flex:1;padding:12px 20px;border:2px solid #e9ecef;border-radius:25px;font-size:15px;outline:none;transition:border-color .2s}
    .chat-input:focus{border-color:#667eea}
    .send-btn,.csv-btn{padding:12px 24px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:25px;cursor:pointer;font-weight:700;transition:transform .2s;font-size:14px}
    .csv-btn{background:#f0f4ff;color:#667eea;padding:8px 16px;font-size:12px}
    .send-btn:hover,.csv-btn:hover{transform:scale(1.05)}
    .send-btn:disabled{opacity:.5;cursor:not-allowed}
    @media (max-width:768px){.chat-container{height:100vh;border-radius:0}.message-content{max-width:85%}.mode-selector{flex-direction:column;gap:5px}}
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="header-top">
        <div class="header-info">
          <div class="bot-avatar">A</div>
          <div class="header-text">
            <h1>Aunikah</h1>
            <p id="modeDescription">
              Smart Employment Assistant
              <span id="detectionBadge"></span>
              <span id="clientBadge"></span>
              <span id="employerBadge"></span>
            </p>
          </div>
        </div>
        <div class="mode-selector">
          <button id="btnEmployee" class="mode-btn active" onclick="switchMode('employee', this)">üë§ Employee</button>
          <button id="btnManager" class="mode-btn" onclick="switchMode('manager', this)">üëî Manager</button>
        </div>
      </div>

      <div class="demo-notice">
        <strong>üß† Smart Detection Active</strong>
        I'll detect your employment type and companies from your questions!
        <button onclick="toggleQuickSetup()" style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 4px 12px; border-radius: 12px; cursor: pointer; font-size: 11px; margin-left: 10px;">Quick Setup</button>
      </div>

      <div class="quick-setup" id="quickSetup">
        <h3>Quick Demo Setup (Optional)</h3>
        <div style="margin-bottom:10px;">
          <strong style="font-size:12px;color:#666;">Where do you work? (Client)</strong>
          <div class="company-buttons">
            <button class="company-btn" onclick="setClient('Google')">Google</button>
            <button class="company-btn" onclick="setClient('Microsoft')">Microsoft</button>
            <button class="company-btn" onclick="setClient('Amazon')">Amazon</button>
            <button class="company-btn" onclick="setClient('Meta')">Meta</button>
          </div>
        </div>
        <div>
          <strong style="font-size:12px;color:#666;">Who employs you? (EOR/Staffing)</strong>
          <div class="company-buttons">
            <button class="company-btn" onclick="setEmployer('Randstad')">Randstad</button>
            <button class="company-btn" onclick="setEmployer('Adecco')">Adecco</button>
            <button class="company-btn" onclick="setEmployer('Manpower')">Manpower</button>
            <button class="company-btn" onclick="setEmployer('Robert Half')">Robert Half</button>
          </div>
        </div>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages"></div>

    <div class="chat-input-container">
      <div class="chat-input-wrapper">
        <!-- Keep CSV button visible for now (optional). It won't break JSON usage. -->
        <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleCSVUpload(event)"/>
        <button class="csv-btn" onclick="document.getElementById('csvInput').click()">üìÅ Upload CSV</button>
        <input id="chatInput" class="chat-input" placeholder="Ask me anything..." onkeypress="handleKeyPress(event)"/>
        <button class="send-btn" onclick="handleSend()">Send</button>
      </div>
    </div>
  </div>

  <!-- Inline JSON FAQs (single-file demo). Add more objects as you wish. -->
  <script type="application/json" id="faq-json">
  [
  {
    "id": "w2_pto_basic",
    "patterns": ["pto","vacation","time off","request pto"],
    "intent": "pto",
    "audience": "employee",
    "priority": 70,
    "answer": "To request PTO as a **[WORKER_TYPE]** at **[CLIENT]**, use **[EOR]**‚Äôs PTO system (the employer on your paystub). Submit dates in **[EOR]**‚Äôs portal and notify your **[CLIENT]** team per norms.",
    "escalate": false,
    "tags": ["w2","pto"]
  },
  {
    "id": "eor_confusion_correction",
    "patterns": ["my manager at","manager at staffing","ask the client","who is my employer","which company is my employer"],
    "intent": "eor_education",
    "audience": "employee",
    "priority": 90,
    "answer": "Quick clarification: You‚Äôre employed by **[EOR]** (see your paystub). **[CLIENT]** is your on-site client. Use **[EOR]** for pay/benefits/HR; use **[CLIENT]** for day-to-day work direction.",
    "escalate": false,
    "tags": ["education","confusion"]
  },

  /* =========================
     Manager ‚Äì Routing & Ops
     ========================= */
  {
    "id": "mgr_pto_routing",
    "patterns": ["team pto","direct report pto","approve pto","pto question from my team"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 90,
    "answer": "For W-2 talent employed by **[EOR]** at **[CLIENT]**: PTO is requested and tracked in **[EOR]**‚Äôs system. As a **[CLIENT]** manager, approve time away per team norms‚Äîdon‚Äôt process PTO in **[CLIENT]** HR tools.",
    "escalate": false,
    "tags": ["manager","pto"]
  },
  {
    "id": "mgr_benefits_routing",
    "patterns": ["team benefits question","contractor benefits","insurance","medical benefits"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 90,
    "answer": "Contractor benefits are handled by **[EOR]** (employer on the paystub), not **[CLIENT]**. Share **[EOR]**‚Äôs HR link or ask the worker to log in to the **[EOR]** portal. If they‚Äôre invoicing (1099), benefits typically are not provided by **[CLIENT]**/**[EOR]**.",
    "escalate": false,
    "tags": ["manager","benefits"]
  },
  {
    "id": "mgr_payroll_routing",
    "patterns": ["team payroll","paycheck problem","direct deposit","tax withholding"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 85,
    "answer": "Payroll issues (late pay, tax withholding, bank changes) go to **[EOR]** payroll. Ask the worker to open a ticket with **[EOR]** and include their assignment at **[CLIENT]**.",
    "escalate": false,
    "tags": ["manager","payroll"]
  },
  {
    "id": "mgr_timekeeping",
    "patterns": ["clock in","timekeeping","timesheet","missed punch","time card"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 80,
    "answer": "If the worker is W-2 via **[EOR]**, official time lives in **[EOR]**‚Äôs tool. If **[CLIENT]** requires local capture, ensure entries sync back to **[EOR]** for payroll. Missed punches should be corrected in **[EOR]** per policy.",
    "escalate": false,
    "tags": ["manager","timekeeping"]
  },
  {
    "id": "mgr_holiday_pay",
    "patterns": ["holiday pay","company holiday","contractor holiday"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 70,
    "answer": "Holiday pay eligibility depends on **[EOR]** policy and classification. Direct workers to **[EOR]** HR/handbook. Avoid promising holiday pay in **[CLIENT]** systems.",
    "escalate": false,
    "tags": ["manager","holiday"]
  },
  {
    "id": "mgr_ot_policy",
    "patterns": ["overtime","ot approval","time over 40","double time"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 80,
    "answer": "Overtime rules vary by jurisdiction and **[EOR]** policy. Require pre-approval; confirm **[EOR]**‚Äôs OT thresholds (daily vs weekly) and code hours correctly so they flow to **[EOR]** payroll.",
    "escalate": false,
    "tags": ["manager","overtime"]
  },
  {
    "id": "mgr_leave",
    "patterns": ["leave of absence","medical leave","fmla","pfml","disability"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 85,
    "answer": "Leaves for W-2 talent are administered by **[EOR]**. Route the worker to **[EOR]**‚Äôs leave team. Your role at **[CLIENT]** is coverage planning and schedule coordination.",
    "escalate": false,
    "tags": ["manager","leave"]
  },
  {
    "id": "mgr_assignment_extend",
    "patterns": ["extension","end date change","renew contract","extend assignment"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 80,
    "answer": "Ask your **[CLIENT]** recruiting/engagement POC to request an extension with **[EOR]** or the staffing vendor. Workers shouldn‚Äôt change end dates directly; **[EOR]** will issue updated terms.",
    "escalate": false,
    "tags": ["manager","assignment"]
  },
  {
    "id": "mgr_end_assignment",
    "patterns": ["end assignment","offboarding","last day","terminate assignment"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 80,
    "answer": "Coordinate end date with **[EOR]** and follow **[CLIENT]** offboarding steps (badge, laptop, access). **[EOR]** handles final pay and any benefits notices.",
    "escalate": false,
    "tags": ["manager","offboarding"]
  },
  {
    "id": "mgr_access_requests",
    "patterns": ["system access","badge access","permissions","app access"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 70,
    "answer": "Submit **[CLIENT]** access tickets per local process. For **[EOR]** systems (time/pay/benefits), the worker must contact **[EOR]** support. Keep roles least-privileged.",
    "escalate": false,
    "tags": ["manager","access"]
  },
  {
    "id": "mgr_equipment",
    "patterns": ["laptop","hardware","equipment issue","device replacement"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 70,
    "answer": "Follow **[CLIENT]** hardware process (ticket or walk-up). If equipment belongs to **[EOR]**/vendor, coordinate replacement through **[EOR]** and document chain of custody.",
    "escalate": false,
    "tags": ["manager","equipment"]
  },
  {
    "id": "mgr_incident",
    "patterns": ["safety incident","injury at work","work injury","incident report"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 85,
    "answer": "If urgent, contact emergency services. Then log the incident in **[CLIENT]**‚Äôs EHS system and notify **[EOR]** immediately so they can handle reporting and benefits guidance.",
    "escalate": true,
    "tags": ["manager","safety"]
  },
  {
    "id": "mgr_conduct_escalation",
    "patterns": ["harassment","code of conduct","complaint","inappropriate behavior"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 90,
    "answer": "Acknowledge the concern. Capture facts, avoid promises, and notify **[CLIENT]** HR immediately. Also alert **[EOR]** HR so both employer and site can coordinate next steps.",
    "escalate": true,
    "tags": ["manager","conduct"]
  },
  {
    "id": "mgr_schedule",
    "patterns": ["schedule change","shift swap","remote day","flex schedule"],
    "intent": "manager_help",
    "audience": "manager",
    "priority": 70,
    "answer": "Set expectations in team norms. For W-2 via **[EOR]**, ensure schedule changes still meet **[EOR]** timekeeping/OT rules. Document approvals in writing.",
    "escalate": false,
    "tags": ["manager","schedule"]
  },

  /* =========================
     Manager ‚Äì Coaching/Engagement/Productivity
     ========================= */
  {
    "id": "mgr_performance_signal",
    "patterns": ["performance concern","quality slipping","missed deadlines","performance issue"],
    "intent": "productivity",
    "audience": "manager",
    "priority": 75,
    "answer": "Use a simple plan: clarify expectations; cite 2‚Äì3 examples; agree on a 1‚Äì2 week plan with checkpoints; identify blockers and support needed. If no improvement, loop in **[EOR]** (employer) for coaching.",
    "escalate": false,
    "tags": ["manager","performance"]
  },
  {
    "id": "mgr_feedback_script",
    "patterns": ["give feedback","coaching script","constructive feedback","how to give feedback"],
    "intent": "engagement",
    "audience": "manager",
    "priority": 70,
    "answer": "Try SBI: Situation, Behavior, Impact. Example: ‚ÄúYesterday in the client review (S), the deck was 15 minutes late (B), which reduced our Q&A time (I). Let‚Äôs commit to a 24-hour dry run.‚Äù Keep it job-related; involve **[EOR]** if trends persist.",
    "escalate": false,
    "tags": ["manager","feedback"]
  },
  {
    "id": "mgr_1on1_template",
    "patterns": ["1:1 agenda","check in template","one on one","weekly check in"],
    "intent": "engagement",
    "audience": "manager",
    "priority": 70,
    "answer": "Quick 1:1: Wins; Top 3 priorities; Risks/blocked; What I need from you; Recognition shoutouts. Keep to 20‚Äì30 minutes weekly; capture actions and dates.",
    "escalate": false,
    "tags": ["manager","engagement"]
  },
  {
    "id": "mgr_recognition_prompts",
    "patterns": ["recognition","kudos","appreciate work","praise"],
    "intent": "engagement",
    "audience": "manager",
    "priority": 65,
    "answer": "Be specific: what they did + impact at **[CLIENT]**. Example: ‚ÄúThanks for catching the API error before release‚Äîsaved hours of rollback.‚Äù Post kudos in team channel to model the behavior.",
    "escalate": false,
    "tags": ["manager","recognition"]
  },
  {
    "id": "mgr_motivation_low",
    "patterns": ["motivation low","morale","burnt out","burnout"],
    "intent": "engagement",
    "audience": "manager",
    "priority": 80,
    "answer": "Signals: slower cycles, fewer updates, defensive tone. Actions: shorten goals to 1-week sprints, clarify ‚Äòdefinition of done‚Äô, swap a routine task for a visible win, and schedule a brief 1:1 to unblock. Recognize progress.",
    "escalate": false,
    "tags": ["manager","engagement"]
  },
  {
    "id": "mgr_productivity_quickstart",
    "patterns": ["productivity","getting unstuck","blocked","stuck"],
    "intent": "productivity",
    "audience": "manager",
    "priority": 75,
    "answer": "3-step reset: (1) Re-order today‚Äôs tasks by impact; pick one 45-minute focus block. (2) Identify the one blocker + owner to remove it. (3) Post a mid-day update in the team channel.",
    "escalate": false,
    "tags": ["manager","productivity"]
  },
  {
    "id": "mgr_meeting_cadence",
    "patterns": ["too many meetings","meeting overload","meeting bloat","inefficient meetings"],
    "intent": "productivity",
    "audience": "manager",
    "priority": 65,
    "answer": "Default to async updates; keep live meetings for decisions. Cap standups at 10‚Äì12 minutes. Use agenda + owner + outcome. End with action items and owners.",
    "escalate": false,
    "tags": ["manager","meetings"]
  },
  {
    "id": "mgr_goal_setting",
    "patterns": ["goals","okr","priorities","set goals"],
    "intent": "productivity",
    "audience": "manager",
    "priority": 70,
    "answer": "Define 1‚Äì3 weekly goals tied to **[CLIENT]** outcomes. For each: why it matters, owner, and done-by date. Post goals Monday; status Thursday; wrap Friday with lessons learned.",
    "escalate": false,
    "tags": ["manager","goals"]
  },
  {
    "id": "mgr_blocker_escalation",
    "patterns": ["blocked","dependency","waiting on","unblocked"],
    "intent": "productivity",
    "audience": "manager",
    "priority": 70,
    "answer": "Escalation template: what is blocked, for whom, when impact hits, and the smallest decision needed. Example: ‚ÄúBlocked on SSO access; deadline EOD Wed; need secops ticket 123 unpaused.‚Äù",
    "escalate": false,
    "tags": ["manager","escalation"]
  },
  {
    "id": "mgr_kudos_program",
    "patterns": ["kudos program","recognition wall","peer recognition"],
    "intent": "engagement",
    "audience": "manager",
    "priority": 60,
    "answer": "Encourage weekly peer kudos: require ‚Äòspecific behavior + impact at **[CLIENT]**‚Äô. Share top kudos in retro. Use tags (Teamwork, Ownership) to align with values.",
    "escalate": false,
    "tags": ["manager","kudos"]
  },
  {
    "id": "mgr_onboarding_week1",
    "patterns": ["onboarding plan","first week","day 1","new hire plan"],
    "intent": "engagement",
    "audience": "manager",
    "priority": 75,
    "answer": "Week 1: laptop/access; team intro; sample tasks; demo data; a buddy; first deliverable by Day 3; 30-min retro end of week. Confirm **[EOR]** time/benefits steps are complete.",
    "escalate": false,
    "tags": ["manager","onboarding"]
  },
  {
    "id": "mgr_remote_inclusion",
    "patterns": ["remote","hybrid","inclusion","async norms"],
    "intent": "engagement",
    "audience": "manager",
    "priority": 60,
    "answer": "Inclusive habits: rotate meeting times, document decisions, call on remote voices first, and use written status updates. Share recordings/notes within 24 hours.",
    "escalate": false,
    "tags": ["manager","inclusion"]
  },
  {
    "id": "mgr_training_budget",
    "patterns": ["training","upskill","learning","course"],
    "intent": "engagement",
    "audience": "manager",
    "priority": 55,
    "answer": "If training is permitted, confirm with **[CLIENT]** and **[EOR]** on eligibility and funding. Low-lift options: internal wikis, shadowing, 30-minute show-and-tell sessions.",
    "escalate": false,
    "tags": ["manager","learning"]
  },
  {
    "id": "mgr_kpi_dashboard",
    "patterns": ["metrics","dashboard","velocity","throughput","quality"],
    "intent": "productivity",
    "audience": "manager",
    "priority": 60,
    "answer": "Track 3 signals: throughput (tasks/week), predictability (planned vs done), quality (defects). Review Mondays; remove one blocker weekly.",
    "escalate": false,
    "tags": ["manager","metrics"]
  },
  {
    "id": "mgr_confusion_check",
    "patterns": ["who is my employer","manager at staffing","ask the client","which company handles benefits"],
    "intent": "eor_education",
    "audience": "manager",
    "priority": 90,
    "answer": "Clarify roles: **[EOR]** is the employer (pay/benefits/HR). **[CLIENT]** directs daily work. Route HR/payroll to **[EOR]**; keep tasking and approvals within **[CLIENT]**.",
    "escalate": false,
    "tags": ["manager","confusion"]
  }
  {
  "id": "emp_benefits_general",
  "patterns": ["benefits","benefit","medical","dental","vision","insurance","benefits enrollment","enroll benefits","open enrollment"],
  "intent": "benefits",
  "audience": "employee",
  "priority": 80,
  "answer": "Benefits for **[WORKER_TYPE]** are administered by **[EOR]** (the employer on your paystub), not **[CLIENT]**. Sign in to **[EOR]**‚Äôs benefits portal or contact **[EOR]** HR for plan options and deadlines.",
  "escalate": false,
  "tags": ["employee","benefits"]
},
{
  "id": "mgr_motivation_general",
  "patterns": ["motivation","motivate","engagement","energize"],
  "intent": "engagement",
  "audience": "manager",
  "priority": 78,
  "answer": "Quick motivation playbook: shorten goals to 1-week wins, clarify a tight ‚Äòdefinition of done‚Äô, swap one rote task for a visible impact task, and schedule a 15-min unblocker 1:1. Recognize progress publicly in the team channel.",
  "escalate": false,
  "tags": ["manager","engagement","motivation"]
}

]
  </script>

  <script>
    // -----------------------
    // State & profile badges
    // -----------------------
    let currentMode = 'employee';    // 'employee' | 'manager'
    let FAQ_ROWS = [];               // populated from inline JSON
    let sessionProfile = { client:null, employer:null, typeHint:null };

    function saveProfile(){ try{ localStorage.setItem('auni_profile', JSON.stringify(sessionProfile)); }catch(e){} }
    function loadProfile(){
      try{
        const raw = localStorage.getItem('auni_profile');
        if(raw) Object.assign(sessionProfile, JSON.parse(raw));
      }catch(e){}
    }

    function updateBadges(){
      const detBadge = document.getElementById('detectionBadge');
      const clientBadge = document.getElementById('clientBadge');
      const emplBadge = document.getElementById('employerBadge');

      detBadge.innerHTML   = sessionProfile.typeHint ? `<span class="badge badge-detection">${sessionProfile.typeHint === 'W2_Contingent' ? 'W2 Contingent' : sessionProfile.typeHint}</span>` : '';
      clientBadge.innerHTML= sessionProfile.client    ? `<span class="badge badge-client">@ ${sessionProfile.client}</span>` : '';
      emplBadge.innerHTML  = sessionProfile.employer  ? `<span class="badge badge-employer">Employed by: ${sessionProfile.employer}</span>` : '';
    }

    // -----------------------
    // Detection dictionaries
    // -----------------------
    const DETECT = {
      w2: ["paycheck","paystub","withholding","pto","benefits enrollment","clock in"],
      w2_contingent: ["staffing company","eor","placed at","assignment","my recruiter","staffing"],
      c1099: ["invoice","bill","freelance","my rate","quarterly taxes","deduct expenses","invoicing"],
      confusion: ["my manager at ","i work for ","my boss at ","i thought you were my manager"]
    };
    const COMPANY_WORDS = {
      knownClients: ["Google","Microsoft","Amazon","Meta","Apple","Netflix"],
      knownEmployers: ["Randstad","Adecco","Manpower","Aerotek","Robert Half","Kelly","Kforce"]
    };

    function detectCompanies(msg){
      const m = msg;
      const foundClient   = COMPANY_WORDS.knownClients.find(c => m.includes(c.toLowerCase()));
      const foundEmployer = COMPANY_WORDS.knownEmployers.find(e => m.includes(e.toLowerCase()));
      if(foundClient)  sessionProfile.client   = foundClient;
      if(foundEmployer)sessionProfile.employer = foundEmployer;
    }

    function inferWorkerType(msg){
      const m = msg;
      let score = { '1099':0, 'W2':0, 'Contingent':0 };
      DETECT.c1099.forEach(k => { if(m.includes(k)) score['1099'] += 2; });
      DETECT.w2.forEach(k => { if(m.includes(k)) score['W2'] += 2; });
      DETECT.w2_contingent.forEach(k => { if(m.includes(k)) { score['W2']++; score['Contingent'] += 2; } });
      const max = Math.max(score['1099'], score['W2']);
      let type = null;
      if (max >= 2) {
        type = score['1099'] > score['W2'] ? '1099' : 'W2';
        if (score['Contingent'] >= 2 && type === 'W2') type = 'W2_Contingent';
      }
      return type || sessionProfile.typeHint || 'Unknown';
    }

    function detectConfusion(msg){ return DETECT.confusion.some(k => msg.includes(k.trim())); }

    // -----------------------
    // JSON loader (inline)
    // -----------------------
    (function loadInlineJson(){
      const raw = document.getElementById('faq-json')?.textContent || '[]';
      try{
        FAQ_ROWS = JSON.parse(raw).map(r => ({
          ...r,
          patterns: Array.isArray(r.patterns) ? r.patterns.map(s => (s||'').toLowerCase()) : [],
          priority: Number(r.priority || 0),
          tags: Array.isArray(r.tags) ? r.tags : []
        }));
        console.log('FAQ loaded (inline JSON):', FAQ_ROWS.length);
      }catch(e){ console.warn('Inline JSON parse error:', e.message); }
    })();

    // -----------------------
    // Helpers
    // -----------------------
    const typos = {
      'benifits':'benefits','benfits':'benefits','bennefits':'benefits',
      'vaccation':'vacation','vacaton':'vacation','insurence':'insurance',
      'holliday':'holiday','payed':'paid','timeoff':'time off'
    };
    function normalizeText(text){
      let t = text.toLowerCase();
      Object.keys(typos).forEach(k => { t = t.replace(new RegExp('\\b'+k+'\\b','gi'), typos[k]); });
      return t;
    }

    function personalize(answer){
      const client = sessionProfile.client || 'the client';
      const eor    = sessionProfile.employer || 'your employer (on your paystub)';
      const worker = sessionProfile.typeHint || 'W-2';
      return (answer||'')
        .replaceAll('[CLIENT]', client)
        .replaceAll('[EMPLOYER]', eor)
        .replaceAll('[EOR]', eor)
        .replaceAll('[WORKER_TYPE]', worker)
        .replaceAll('[Client Company]', client); // legacy placeholder in your old text
    }

    function bestAnswerFor(msg, audience='employee'){
      const m = normalizeText(msg);
      const scored = FAQ_ROWS
        .filter(r => !r.audience || r.audience === audience)
        .map(r => {
          const hits = (r.patterns||[]).reduce((a,p)=> a + (p && m.includes(p) ? 1 : 0), 0);
          return { r, score: hits*10 + r.priority };
        })
        .filter(x => x.score > 0)
        .sort((a,b)=> b.score - a.score);
      return scored[0]?.r || null;
    }

    async function handleUserMessage(msg, audience='employee'){
      const lower = normalizeText(msg);

      // Detect companies + type
      detectCompanies(lower);
      sessionProfile.typeHint = inferWorkerType(lower);
      saveProfile();
      updateBadges();

      // Greetings & thanks
      if (/\b(hi|hello|hey)\b/.test(lower)) {
        return audience === 'employee'
          ? "Hello! üòä I‚Äôll figure out your employment type from your questions. Just ask away!"
          : "Hello! üëî I‚Äôm here to help you answer your team‚Äôs PTO/benefits questions.";
      }
      if (/\b(thank|thanks)\b/.test(lower)) return "You're welcome! üåü";
	  
	  // Benefits safety net
if (/\bbenefit(s)?\b/.test(lower)) {
  const eor = sessionProfile.employer || 'your employer (on your paystub)';
  const wt  = sessionProfile.typeHint || 'W-2';
  return `Benefits for **${wt}** are handled by **${eor}**, not [CLIENT]. Log into **${eor}**‚Äôs benefits portal or contact their HR for plan options and deadlines.`;
}


      // Confusion override
      const confusion = detectConfusion(lower);

      let picked = bestAnswerFor(lower, audience);
      if (confusion) {
        const edu = FAQ_ROWS.find(r => r.intent === 'eor_education' && (!r.audience || r.audience === audience));
        if (edu) picked = edu;
      }

      if (!picked) return "I'm not finding a match. Try asking about:\n\n‚Ä¢ Benefits and insurance\n‚Ä¢ PTO and time off\n‚Ä¢ Payroll and paystubs\n‚Ä¢ Who your employer is";

      // Compose response
      let response = personalize(picked.answer);
      if (confusion) {
        const c = sessionProfile.client   || '[your client]';
        const e = sessionProfile.employer || '[your employer]';
        response += `\n\nüí° **Quick clarification:**\n‚Ä¢ You work ON-SITE at **${c}**\n‚Ä¢ You‚Äôre employed BY **${e}** (check paystub)\n‚Ä¢ ${e} handles pay/benefits/HR ‚Äî not ${c}`;
      }

      // Type banner if confident
      if (sessionProfile.typeHint && sessionProfile.typeHint !== 'Unknown') {
        const label = sessionProfile.typeHint === 'W2_Contingent' ? 'W2 contingent worker' : sessionProfile.typeHint;
        response = `üîç Based on your question, you're a **${label}**.\n\n` + response;
      }
      return response;
    }

    // -----------------------
    // UI wiring
    // -----------------------
    function toggleQuickSetup(){
      const el = document.getElementById('quickSetup');
      el.classList.toggle('active');
    }
    function setClient(name){ sessionProfile.client = name; saveProfile(); updateBadges(); addMessage(`I work at ${name}`,'user'); setTimeout(()=>addMessage(`Got it! You work at ${name}. I'll personalize my answers for you!`,'bot'), 500); }
    function setEmployer(name){ sessionProfile.employer = name; saveProfile(); updateBadges(); addMessage(`I'm employed by ${name}`,'user'); setTimeout(()=>addMessage(`Perfect! ${name} is your employer. I'll direct you to them for HR questions.`,'bot'), 500); }

    function switchMode(mode, btn){
      currentMode = mode;
      document.getElementById('btnEmployee').classList.remove('active');
      document.getElementById('btnManager').classList.remove('active');
      btn.classList.add('active');

      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';

      const desc = document.getElementById('modeDescription');
      if (mode === 'employee') {
        desc.childNodes[0].textContent = 'Smart Employment Assistant';
        addMessage("Hi! üë§ I'm here to answer your employment questions. I'll figure out your type from your questions - just ask!", 'bot');
      } else {
        desc.childNodes[0].textContent = 'Manager Support - Team Q&A Helper';
        addMessage("Hi! üëî I'm here to help you answer your team's PTO and benefits questions, especially for contingent workers!", 'bot');
      }
      updateBadges();
    }

    function addMessage(text, sender){
      const messages = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      div.innerHTML = `
        <div class="message-avatar">${sender === 'bot' ? 'A' : 'You'}</div>
        <div class="message-content">${text}</div>
      `;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function handleKeyPress(e){ if(e.key === 'Enter') handleSend(); }

    function handleSend(){
      const input = document.getElementById('chatInput');
      const raw = input.value.trim();
      if (!raw) return;

      addMessage(raw, 'user');
      input.value = '';

      const messages = document.getElementById('chatMessages');
      const typing = document.createElement('div');
      typing.className = 'message bot';
      typing.innerHTML = `
        <div class="message-avatar">A</div>
        <div class="typing-indicator active">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>`;
      messages.appendChild(typing);

      setTimeout(async () => {
        typing.remove();
        const audience = (currentMode === 'manager') ? 'manager' : 'employee';
        const response = await handleUserMessage(raw, audience);
        addMessage(response, 'bot');
      }, 800);
    }

    // Optional: keep CSV upload working (will overwrite FAQs in-memory)
    function handleCSVUpload(event){
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try{
          parseCSV(e.target.result);
          addMessage("‚úÖ CSV loaded! Your custom Q&As are active.", 'bot');
        }catch(err){
          addMessage("‚ùå Error loading CSV. Check format.", 'bot');
        }
      };
      reader.readAsText(file);
    }
    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(Boolean);
      const parsed = [];
      // Expect header like: id,pattern,intent,audience,priority,answer,escalate,tags
      lines.shift();
      for(const line of lines){
        const cols = splitCsv(line);
        if (!cols.length) continue;
        const [id, pattern, intent, audience, priority, answer, escalate, tags] = cols;
        parsed.push({
          id: (id||'').trim(),
          patterns: (pattern||'').split(/[;,]/).map(s=>s.trim().toLowerCase()).filter(Boolean),
          intent: (intent||'').trim(),
          audience: (audience||'employee').trim(),
          priority: Number(priority||0),
          answer: (answer||'').trim(),
          escalate: String(escalate||'no').toLowerCase()==='yes',
          tags: (tags||'').split(/[;,]/).map(s=>s.trim()).filter(Boolean)
        });
      }
      FAQ_ROWS = parsed;
      console.log('FAQ reloaded from CSV:', FAQ_ROWS.length);
    }
    function splitCsv(line){
      const out=[]; let cur=''; let q=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch === '"'){ q=!q; continue; }
        if(ch === ',' && !q){ out.push(cur); cur=''; continue; }
        cur += ch;
      }
      out.push(cur);
      return out;
    }

    // Boot
    (function init(){
      loadProfile();
      switchMode('employee', document.getElementById('btnEmployee'));
      updateBadges();
    })();
  </script>
</body>
</html>
